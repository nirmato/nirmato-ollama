name: 'Setup environment for the build'

inputs:
    cache-disabled:
        description: 'gradle.cache-disabled'
        default: 'false'
    cache-read-only:
        description: 'gradle.cache-read-only'
        default: 'false'
    java-version:
        description: 'Java version'
        default: '17'

runs:
    using: 'composite'
    steps:
        -   name: Configure JDK
            uses: actions/setup-java@f2beeb24e141e01a676f977032f5a29d81c9e27e #v5.1.0
            with:
                distribution: 'zulu'
                java-version: ${{ inputs.java-version }}

        -   uses: gradle/actions/setup-gradle@4d9f0ba0025fe599b4ebab900eb7f3a1d93ef4c2 #v5.0.0
            with:
                validate-wrappers: true
                cache-disabled: ${{ inputs.cache-disabled }}
                cache-read-only: ${{ inputs.cache-read-only }}

        -   name: Cache Gradle Wrapper
            uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb #v5.0.1
            id: gradle-wrapper-cache
            with:
                path: ~/.gradle/wrapper
                key: ${{ runner.os }}-gradle-wrapper-${{ hashFiles('gradle/wrapper/gradle-wrapper.properties') }}
                restore-keys: ${{ runner.os }}-gradle-wrapper-
                enableCrossOsArchive: true

        -   name: Cache Node Modules
            uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb #v5.0.1
            id: gradle-yarn-cache
            with:
                path: build/js/node_modules
                key: ${{ runner.os }}-yarn-${{ hashFiles('gradle/js/yarn.lock') }}
                restore-keys: ${{ runner.os }}-yarn-
                enableCrossOsArchive: true

        -   name: Initialize Gradle wrapper
            if: matrix.os == 'ubuntu-latest' || matrix.os == 'macos-latest'
            run: chmod +x ./gradlew
            shell: "bash"

        -   name: Cache Konan
            uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb #v5.0.1
            with:
                path: |
                    ~/.konan/cache
                    ~/.konan/dependencies
                    ~/.konan/kotlin-native-macos*
                    ~/.konan/kotlin-native-mingw*
                    ~/.konan/kotlin-native-windows*
                    ~/.konan/kotlin-native-linux*
                    ~/.konan/kotlin-native-prebuilt-macos*
                    ~/.konan/kotlin-native-prebuilt-mingw*
                    ~/.konan/kotlin-native-prebuilt-windows*
                    ~/.konan/kotlin-native-prebuilt-linux*
                key: ${{ runner.os }}-konan-${{ hashFiles('**/*.gradle*') }}
                restore-keys: |
                    ${{ runner.os }}-konan-

        -   if: matrix.os == 'Windows'
            uses: msys2/setup-msys2@4f806de0a5a7294ffabaff804b38a9b435a73bda #v2.30.0
            with:
                release: false
                install: mingw-w64-x86_64-openssl
